#!/bin/bash
set -e

# Configuration
POST_URL="http://localhost:9090/api/collections"
HTML_URL="http://localhost:9090"
LOGDIR="./log"
LOGFILE="$LOGDIR/test-$(date +%Y%m%d-%H%M%S).log"

# Ensure log directory exists
mkdir -p "$LOGDIR"

# Fetch commit info
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_MSG=$(git log -1 --pretty=%s)

# Start log
{
  echo "üïí Timestamp: $(date)"
  echo "üî¢ Commit: $COMMIT_HASH"
  echo "üìù Message: $COMMIT_MSG"
  echo "======================================="
  echo "üîÑ Restarting server via restart-server.sh..."
} | tee "$LOGFILE"

./local/restart-server.sh | tee -a "$LOGFILE"

echo "‚è≥ Waiting for server to be ready..." | tee -a "$LOGFILE"
sleep 3

echo "üî¨ Running POST test..." | tee -a "$LOGFILE"
if ! ./local/post-check.py "$POST_URL" 2>&1 | tee -a "$LOGFILE"; then
  echo "‚ùå POST test failed" | tee -a "$LOGFILE"
  exit 1
fi

echo "üî¨ Running HTML test..." | tee -a "$LOGFILE"
if ! ./local/html-check.js "$HTML_URL" 2>&1 | tee -a "$LOGFILE"; then
  echo "‚ùå HTML test failed" | tee -a "$LOGFILE"
  exit 1
fi

echo "‚úÖ All tests passed" | tee -a "$LOGFILE"
exit 0
