# Stage 1: Build
FROM ubuntu:20.04

LABEL maintainer="benedikt.budig@uni-wuerzburg.de"
LABEL org.opencontainers.image.source="https://github.com/benedikt-budig/glyph-miner"

ENV DEBIAN_FRONTEND=noninteractive

# Install basic dependencies
RUN apt-get update && apt-get install -y \
    g++ git make mysql-server nginx \
    python3 python3-dev python3-numpy \
    python3-mysqldb python3-pil python3-pip \
    libpq-dev libjpeg-dev libfreetype6-dev zlib1g-dev \
    libxml2-dev libxslt-dev build-essential gcc \
    && rm -rf /var/lib/apt/lists/*

# Install uWSGI
RUN pip3 install uwsgi web.py

# Set working directory
WORKDIR /opt/glyph-miner

# Clone your updated source
RUN git clone https://github.com/jsbien/glyph-miner . 

# OPTIONAL: If needed, clean leftover wrong files
# RUN rm -f docker/wsgi.py

# Expose uWSGI HTTP port
EXPOSE 9090

# Start using uWSGI properly
CMD ["uwsgi", "--http", ":9090", "--wsgi-file", "server/web/wsgi.py", "--callable", "app"]
